<style>
  th.date {
    width: 9em;
  }

  th.action {
    width: 9em;
  }

  .wordwrap {
    word-wrap: break-word;
    white-space: initial;
    display: inline-block;
  }

</style>
<%- partial('../partial/sidemenu.ejs') %>
  <div class="content admin w-100">
    <h5 class="main-heading1">
      最新消息管理<span class="highlight">系統</span>
      <a class="btn btn-primary btn-sm" href="/admin/news/create">新增條目</a>
    </h5>




    <% var data={}; news.forEach(function(item) { if (!data[item.category]) { data[item.category]=[]; }
      data[item.category].push(item); }); %>
      <% Object.keys(data).forEach(function(cat) { %>
        <section>
          <h6 class="main-heading2 mb-0">
            <%=cat%>
          </h6>
          <table class="table table-striped table-sm">
            <thead>
              <tr>
                <th class="date">日期</th>
                <th>內文</th>
                <th class="action">
                </th>
              </tr>
            </thead>
            <tbody>
              <% (data[cat] || []).forEach(function(item){%>
                <tr>
                  <td class="date" style="width: 9em">
                    <% if(new Date(item.startDate).getDate() < 10){%>0<%}%><%= new Date(item.startDate).getDate() %>-<% if(new Date(item.startDate).getMonth()+1 < 10){%>0<%}%><%= new Date(item.startDate).getMonth()+1 %>-<%= new Date(item.startDate).getFullYear() %>
                  </td>
                  <td class="wordwrap" style="width: 30em">
                    <%- item.newsName %>
                    <div class="wordwrap" style="width: 30em;">
                      <%- item.content %>
                    </div>
                  </td>

                  <td class="action">
                    <a class="btn btn-primary" href="/admin/news/detail/<%=item.id%>">編輯</a>
                    <!-- <button class="btn btn-danger ajax-with-confirm" data-action="/admin/news/detail/<%=item.id%>" data-method="DELETE" data-callback200="location.reload(true);">刪除</button> -->
                    <button class="btn btn-danger" onclick="deleteNews('<%=item.id%>')">刪除</button>
                  </td>
                </tr>
                <% }); %>
            </tbody>
          </table>
        </section>
        <% }); %>

  </div>

  <script>
    async function deleteNews(id) {
      var r = confirm("確定刪除?");

      if (r) {
        var response = await fetch("/admin/news/detail/" + id, {
          method: "DELETE"
        });

        if (response.ok) {
          location.assign('/admin/news/')
        } else {
          alert(response.status + ": " + response.statusText);
        }

      } else {
        alert("已刪除");
      }
    };
  </script>